!function(e,t){"use strict";function l(e,t,l){if(e.alive){var i=e.body,o=i.center.x,a=i.center.y,r=Math.floor(o/16),s=Math.floor(a/16),n=t[r+16*s];n&&n.alive&&l(e,n)}}function i(e,t,l){var i,o,a=e.children.length;if(a>0&&Object.keys(t).length>0)for(o=0;a>o;o++)if(i=e.children[o],i.alive){var r=i.body,s=r.center.x,n=r.center.y,h=Math.floor(s/16),u=Math.floor(n/16),d=t[h+16*u];d&&d.alive&&l(i,d)}}function o(e,t,l,i){var o,a,r,s,n,h,u;if(e.alive&&(o=t.children.length,o>0))for(n=e.body,h=n.center.x,u=n.center.y,s=0;o>s&&(a=t.children[s],!a.alive||i&&!a[i]||(r=a.body,!(Math.abs(r.center.y-u)<d&&Math.abs(r.center.x-h)<d)||(n.right-1<r.x||n.bottom-1<r.y||n.x>r.right-1||n.y>r.bottom-1||(l(e,a),e.alive))));s++);}function a(e,t,l,i){var o,a,r,s,n,h,u,y;if(n=e.children.length,n>0&&(o=t.children.length,o>0))for(s=0;o>s;s++)if(a=t.children[s],a&&a!==h&&a.alive&&(!i||a[i])&&(r=a.body,r.width>0&&r.height>0)){var m=r.center.y;for(y=0;n>y;y++){h=e.children[y];var u=h.body;if(h.alive&&Math.abs(u.center.y-m)<d&&Math.abs(u.center.x-r.center.x)<d&&!(u.right-1<r.x||u.bottom-1<r.y||u.x>r.right-1||u.y>r.bottom-1||(l(h,a),a.alive)))break}}}function r(t,l){var i=t.game;e.startExplosion(i,t.x,t.y,t.width,t.height),i.sound.mute||i.soundExplosion.play(),t.customMortal&&t.kill()}function s(t,l){t.kill(),e.startSpark(t.game,t.x,t.y)}function n(t,l){t.kill(),e.startExplosionSmall(l.game,t.x,t.y)}function h(t,l){if(t.alive&&l.alive){var i=t.game;if(t.customEnemyImpass){if(t===l)return;e.startExplosion(i,l.x,l.y,l.width,l.height),i.sound.mute||i.soundExplosion.play(),l.kill()}if(l.customEnemyImpass){if(t===l)return;e.startExplosion(i,t.x,t.y,t.width,t.height),i.sound.mute||i.soundExplosion.play(),t.kill()}}}function u(t,l){if(l.alive&&t.alive){var i=l.game,o=i.player,a=0;if(l.health>=0){if(l.health<11&&e.startExplosionSmall(i,t.x,t.y-8),l.customDoWhenHit&&l.customDoWhenHit(t),t.passThrough&&Math.random()<t.passThrough)return;var r=t.strengthHp,s=l.health-r<0?l.health:r;a=s,l.health-=s,t.strengthHp-=r,t.strengthHp<=0&&t.kill(),e.startSpark(i,t.x,t.y-4),i.sound.mute||i.soundExplosionShort.play()}if(l.health<=0){var n=l.customName;if(n===o.customChainLast)if(o.customChainCount<2)o.setChainCount(o.customChainCount+1);else{var h=1e3*i.time.totalElapsedSeconds()-o.customChainTimeMs,u=Math.max(1,Math.round(2e3/h));a+=l.customHealthOriginal*o.customChainCount*u,o.setChainCount(0);var d=i.add.image(l.x,l.y,"img-explosion-combo-spritesheet");d.anchor.setTo(.5,.5),d.animations.add("animation-on"),d.animations.play("animation-on",16,!1,!0),i.sound.mute||i.soundCombo.play()}else o.customChainLast=n,o.customChainTimeMs=1e3*i.time.totalElapsedSeconds(),o.setChainCount(1);a+=l.customScoreBonus,i.sound.mute||i.soundExplosion.play(),l.customDoWhenDestroyed&&l.customDoWhenDestroyed(t),l.destroy(),e.startExplosion(i,l.x,l.y,l.width,l.height)}o.incrementScore(a),i.domElementScore.innerHTML=Math.floor(o.customScore),i.domElementLatestScore.innerHTML=Math.floor(a)}}e.Level=function(t,l){if(!(this instanceof e.Level))throw new Error("This is a constructor, call it using new !");this.game=t,this.lastFps=null,this.lastVisibleScore=null,this.levelConfig=null,this.levelData=null,this.levelLineArrayIndex=0,this.tileAtlasKey=l,this.levelAccuSpeedInc=0,this.game.screenCellCountX=this.game.width/16,this.game.screenCellCountY=this.game.height/16,this.game.customTint=16777215},e.Level.prototype.readLevelFiles=function(t){var l=this.game;l.paused=!0;var i=this;console.info("Attempting to load level: "+t);var o=new e.LevelLoader;o.loadLevel(t,function(e,a){console.info("Entering level load callback."),i.levelConfig=a,i.levelData=e,console.info("Loaded level: "+t),i.initAfterLevelLoad(i.levelData.linesArray[1].length,i.levelData.linesArray.length),i.textureByChar=i.levelConfig.textureByChar,i.enemyByChar=i.levelConfig.enemyByChar,l.customLevelSpeed=60,i.loadLines(1,l.screenCellCountY),console.info("Level loaded"),l.paused=!1,o=null})},e.Level.prototype.initAfterLevelLoad=function(t,l){if(t<this.game.screenCellCountX||l<this.game.screenCellCountY)return void alert("Incorrect level width or height !");var i=this.game;i.customBounds=new Phaser.Rectangle(0,0,16*t,16*l),i.world.setBounds(i.customBounds.x,i.customBounds.y,i.customBounds.width,i.customBounds.height),i.camera.x=0,i.camera.y=i.world.height-i.height,i.customTint||(i.customTint=16777215),this.background=i.add.image(0,0,"background-deepest"),this.background.texture.baseTexture.scaleMode=PIXI.scaleModes.NEAREST,this.background.fixedToCamera=!0,16777215!==i.customTint&&(this.background.tint=i.customTint),i.cache.checkImageKey("background-middleLayer")&&(this.middleLayer=i.add.tileSprite(0,0,i.width,i.height,"background-middleLayer"),this.middleLayer.texture.baseTexture.scaleMode=PIXI.scaleModes.NEAREST,this.middleLayer.fixedToCamera=!0,16777215!==i.customTint&&(this.middleLayer.tint=i.customTint)),this.tileGroupBelow=new Phaser.Group(i,null,"group-tiles-below"),this.tileGroupBelow.enableBody=!1,this.tileGroupBelow=new Phaser.Group(i,null,"group-tiles"),this.tileGroupBelow.enableBody=!1,this.tileGroupCollidable=new Phaser.Group(i,null,"group-tiles-collidable"),this.tileGroupCollidable.enableBody=!0,this.tileGroupCollidable.physicsBodyType=Phaser.Physics.ARCADE,this.tileByCellPos={},this.tileGroupAbove=new Phaser.Group(i,null,"group-tiles-above"),this.tileGroupAbove.enableBody=!1;var o,a;null!==this.levelData.playerLine&&null!==this.levelData.playerCol?(o=16*this.levelData.playerCol+8,a=i.world.height-16*this.levelData.playerLine+8,this.levelLineArrayIndex=this.levelData.playerLine,i.camera.y=a-.5*i.screenCellCountY*16):(o=i.world.width/2,a=i.world.height-32);var r=new Phaser.Sprite(i,o,a,"ship");this.player=new e.Player(i,r);var s=this.player;this.game.player=s,this.enemyGroup=new Phaser.Group(i,null,"group-enemy"),this.enemyBulletPools=[],this.enemyBulletPoolByName={};var n=this.levelConfig.enemyBulletStandardTextureId,h=e.createBulletPool(i,64,n?n:"bullet-orange");this.enemyBulletPoolByName.standard=h,this.enemyBulletPools.push(h);var u=this.levelConfig.enemyBulletSecondaryTextureId,d=e.createBulletPool(i,64,u?u:"bullet-purple");this.enemyBulletPoolByName.secondary=d,this.enemyBulletPools.push(d);var y=new e.EnemyFactory(i);this.enemyFactory=y,i.add.existing(this.tileGroupBelow),i.add.existing(this.tileGroupCollidable),i.add.existing(this.enemyGroup),i.add.existing(s.sprite);for(var m=0;m<s.bulletPools.length;m++){var c=s.bulletPools[m];i.add.existing(c)}i.add.existing(this.tileGroupAbove);for(var p=0;p<this.enemyBulletPools.length;p++){var c=this.enemyBulletPools[p];i.add.existing(c)}var v=i.input.keyboard,f=[Phaser.Keyboard.SPACEBAR,Phaser.Keyboard.SHIFT,Phaser.Keyboard.ENTER,Phaser.Keyboard.CONTROL];v.addKeyCapture(f),console.debug("initAfterLevelLoad done.")},e.Level.prototype.parallaxScrolling=function(){},e.Level.prototype.moveLevel=function(){var e=this.game,t=5+Math.round((e.world.height-e.camera.y)/16);this.levelLineArrayIndex<t&&this.loadLines(this.levelLineArrayIndex,t)},e.Level.prototype.update=function(){if(0===this.levelLineArrayIndex)return void console.error("Check level loading, something went wrong.");var t=this.game,d=this.player,y=this.tileGroupCollidable;0!==t.time.fps&&t.time.fps!==this.lastFps&&(this.lastFps=t.time.fps,t.domElementFps.innerHTML=this.lastFps);var m=t.time.physicsElapsedMS;if(d.update(),0===t.customLevelSpeed)e.allDead(this.enemyGroup)&&(t.customLevelSpeed=60);else{var c=t.camera.y,p=m/(1e3/t.customLevelSpeed),v=0;if(1>p?(this.levelAccuSpeedInc+=p,this.levelAccuSpeedInc>=1&&(v=this.levelAccuSpeedInc,this.levelAccuSpeedInc=0)):v=p,v>0){t.camera.y-=v;var f=c-t.camera.y;d.sprite.y-=Math.round(f),this.parallaxScrolling&&this.parallaxScrolling(f)}}this.moveLevel(),l(d.sprite,this.tileByCellPos,r);for(var g=0;g<d.bulletPools.length;g++){var x=d.bulletPools[g];x.length&&i(x,this.tileByCellPos,s)}for(var b=0;b<this.enemyBulletPools.length;b++){var x=this.enemyBulletPools[b];i(x,this.tileByCellPos,s)}if(y.length>0){o(d.sprite,y,r);for(var g=0;g<d.bulletPools.length;g++){var x=d.bulletPools[g];x.length&&a(x,y,s)}for(var b=0;b<this.enemyBulletPools.length;b++){var x=this.enemyBulletPools[b];a(x,y,n)}}for(var b=0;b<this.enemyBulletPools.length;b++){var x=this.enemyBulletPools[b];a(x,this.enemyGroup,function(e,t){e.kill()},"customEnemyBulletImpass")}o(d.sprite,this.enemyGroup,function(l,i){e.startExplosion(t,l.x,l.y,l.width,l.height),t.sound.mute||t.soundExplosion.play(),d.sprite.customMortal&&l.kill()},"customPlayerImpass"),a(this.enemyGroup,this.enemyGroup,h);for(var g=0;g<d.bulletPools.length;g++){var x=d.bulletPools[g];x.length&&i(x,this.tileByCellPos,s)}for(var g=0;g<d.bulletPools.length;g++){var x=d.bulletPools[g];x.length&&a(x,this.enemyGroup,u)}for(var P=function(l,i){l.alive&&i.alive&&(i.kill(),e.startExplosion(t,i.x,i.y,l.width,l.height),t.sound.mute||t.soundExplosion.play(),l.customMortal&&l.kill())},b=0;b<this.enemyBulletPools.length;b++)x=this.enemyBulletPools[b],o(d.sprite,x,P);this.checkBounds()},e.Level.prototype.checkBounds=function(){var e=this.game,t=this.player,l=e.customBounds;l.y=e.camera.y;for(var i=l.x-32,o=l.y-32,a=l.x+l.width+32,r=l.y+e.height+32,s=function(e){e.x<i||e.x>a?e.kill():(e.y<o||e.y>r)&&e.kill()},n=0;n<this.enemyBulletPools.length;n++){var h=this.enemyBulletPools[n];h.forEachAlive(s)}for(var u=0;u<t.bulletPools.length;u++){var h=t.bulletPools[u];h.forEachAlive(s)}var d=l.x+l.width+64,y=l.y+e.height+64,m=function(e){e.x<l.x-64||e.x>d?e.destroy():(e.y<l.y-256||e.y>y)&&e.destroy()};this.enemyGroup.forEachAlive(m);var c=this.tileByCellPos,p=l.y+e.height+64,v=function(e){if(e.y>p&&(e.destroy(),16===e.width&&e.height<21)){var t=e.x/16,l=e.y/16;delete c[t+16*l]}};this.tileGroupBelow.forEachAlive(v),this.tileGroupCollidable.forEachAlive(v),this.tileGroupAbove.forEachAlive(v);var f=.5*t.sprite.width;t.sprite.x-f<l.x&&(t.sprite.x=l.x+f),t.sprite.x+f>l.x+e.width&&(t.sprite.x=l.x+e.width-f);var g=.5*t.sprite.height;t.sprite.y-g<l.y&&(t.sprite.y=l.y+g),t.sprite.y+g>l.y+e.height&&(t.sprite.y=l.y+e.height-g)},e.Level.prototype.loadLines=function(e,t){if(!(e>=0&&t>=e)){var l="loadLines: must be defined and upperLine must be <= upperLine "+e+" - "+t;throw alert(l),new Error(l)}for(var i=this.game,o=this.player,a=this.textureByChar,r=this.enemyByChar,s=this.levelData,n=this.tileGroupBelow,h=this.tileGroupCollidable,u=this.tileGroupAbove,d=this.tileByCellPos,y=s.annotationsByLine,m=s.linesArray,c=Math.min(t,m.length),p=e;c>p;p++){var v=m[p],f=y[p];f&&f.levelSpeed>=0&&(i.customLevelSpeed=f.levelSpeed);for(var g=v.length-1;g>=0;g--){var x=v[g],b=x.character;if("-"!==b)if(b===b.toLowerCase()){var P=a[b];if(P){P.character=b;var w,C=P.framePrefix;if(w=P.impass?C?new Phaser.Sprite(i,16*g,i.world.height-16*p,this.tileAtlasKey):new Phaser.Sprite(i,16*g,i.world.height-16*p,this.tileAtlasKey,P.filename):C?new Phaser.Image(i,16*g,i.world.height-16*p,this.tileAtlasKey):new Phaser.Image(i,16*g,i.world.height-16*p,this.tileAtlasKey,P.filename),P.framePrefix&&P.frameCount&&P.frameFPS){var B=Phaser.Animation.generateFrameNames(P.framePrefix,1,P.frameCount,"",3);w.animations.add(P.framePrefix,B,P.frameFPS,!0),w.animations.play(P.framePrefix)}if(w.width>500)return void alert("Could not find entry '"+P.filename+"' in "+this.tileAtlasKey);if(16777215!==i.customTint&&(w.tint=i.customTint),w.checkWorldBounds=!1,w.outOfBoundsKill=!1,"top"===P.layer)u.addAt(w,0,!0);else if(P.impass){if(16===w.width&&w.height<=20){n.addAt(w,0,!0),i.physics.enable(w,Phaser.Physics.ARCADE);var L=w.x/16,A=w.y/16;d[L+16*A]=w}else h.addAt(w,0,!0);w.body.allowGravity=!1,w.body.allowRotation=!1,w.body.immovable=!0,w.body.customSeparateX=!0,w.body.customSeparateY=!0}else n.addAt(w,0,!0)}}else if(b===b.toUpperCase()){var E=r[b];if(E){var S,G,k=16*g,T=i.world.height-16*p;if(f){if(S=f.randomEnemy?f.randomEnemy>=0?f.randomEnemy:0:null,f.difficultyLevel){var M=f.difficultyLevel;"easy"===M?G=.7:"medium"===M?G=1:"hard"===M?G=1.1:(alert("Unknown difficulty level '"+M+"'. At line "+p),G=null)}else G=null;if(f.trigger){if(!this[f.trigger])throw new Error("Expecting trigger function '"+f.trigger+"' on level.");this[f.trigger](k,T)}}else S=null,G=null;var I=this.enemyFactory.buildEnemy(E,k,T,S,G,o.sprite,this.enemyBulletPoolByName,this.enemyGroup);if(null!==I)for(var D=0;D<I.length;D++){var F=I[D];this.enemyGroup.add(F)}}}}}this.levelLineArrayIndex=c};var d=100;e.allDead=function(e){var t=e.children,l=t.length,i=!0;if(l){var o,a;for(o=0;l>o;o++)if(a=t[o],a.alive){i=!1;break}}return i}}(window.stg=window.stg||{});